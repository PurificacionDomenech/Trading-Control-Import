ial, sans-serif; margin: 0; padding: 20px; background-color: #1a1a1a; color: #ffffff; } .container { max-width: 1200px; margin: 0 auto; background-color: #2d2d2d; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); } h1 { text-align: center; color: #37c3c3f8; font-size: 24px; } h2 { color: #ffffff; font-size: 20px; } h3 { color: #f4f7f7; font-size: 18px; } .account-controls { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 10px; background-color: #2d2d2d; border-radius: 5px; } .account-controls select { flex-grow: 1; margin-right: 10px; background-color: #1a1a1a; border: 1px solid #4b5563; color: #ffffff; padding: 8px; border-radius: 4px; } .account-controls button { margin-left: 5px; } .tabs { display: flex; margin-bottom: 20px; } .tab { padding: 10px 20px; cursor: pointer; background-color: #3a3a3a; border: none; flex: 1; text-align: center; color: #b3b3b3; transition: background-color 0.3s, color 0.3s; } .tab:hover { background-color: #00f2eaba; color: #000000; } .tab.active { background-color: #00f2eac7; color: #000000; } .tab-content { display: none; } .tab-content.active { display: block; } .retos-seccion-bloque { margin-bottom: 2rem; /* A√±ade un espacio entre las secciones Semanal, Mensual e Historial */ } .form-group { margin-bottom: 15px; } label { display: block; margin-bottom: 5px; font-weight: bold; color: #b3b3b3; } input, select, textarea { width: 100%; padding: 8px; border: 1px solid #4b5563; border-radius: 4px; box-sizing: border-box; background-color: #1a1a1a; color: #ffffff; transition: border-color 0.3s; } input:focus, select:focus, textarea:focus { outline: none; border-color: #ecf4f3; } input::placeholder, textarea::placeholder { color: #6b7280; } input[type="number"] { appearance: textfield; -moz-appearance: textfield; -webkit-appearance: textfield; } input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { appearance: none; -webkit-appearance: none; margin: 0; } button { background-color: #00f2eaca; color: #000000; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; transition: background-color 0.3s; } button:hover { background-color: #00d4d0c2; } .button-secondary { background-color: #58f5e8b7; } .button-secondary:hover { background-color: #166978; } .button-danger { background-color: #ef44bc6c; } .button-danger:hover { background-color: #dc2693bd; } .button-small { width: auto; padding: 5px 10px; font-size: 14px; } table { width: 100%; border-collapse: collapse; margin-top: 20px; } th, td { padding: 10px; text-align: left; border-bottom: 1px solid #4b5563; } th { background-color: #2d2d2d; color: #b3b3b3; } tr:nth-child(even) { background-color: #1f1f1f; } .negative { color: #ef449f; } .positive { color: #10b0b9; } .warning { color: #f7f5f1; } .operation-bullish { background-color: rgba(16, 185, 129, 0.1); } .operation-bearish { background-color: rgba(239, 68, 68, 0.1); } .filter-controls { margin-bottom: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; } .dashboard-card { background-color: #2d2d2d; border-radius: 5px; padding: 15px; margin-bottom: 15px; border: 1px solid #4b5563; transition: box-shadow 0.3s; } .dashboard-card:hover { box-shadow: 0 4px 15px rgba(0, 242, 234, 0.2); } .card-stats { display: flex; justify-content: space-between; flex-wrap: wrap; } .stat-box { background-color: #1f1f1f; border-radius: 5px; padding: 10px; margin-bottom: 10px; flex: 1; min-width: 45%; margin: 5px; text-align: center; } .stat-box h4 { margin: 0 0 5px 0; color: #b3b3b3; font-size: 0.9em; } .stat-box p { margin: 0; font-size: 1.1em; font-weight: bold; } .progress-container { width: 100%; background-color: #4b5563; border-radius: 5px; height: 20px; margin-top: 10px; position: relative; } .progress-bar { height: 100%; border-radius: 5px; background-color: #10b9b9; transition: width 0.3s; } .progress-bar.warning { background-color: #f59e0b; } .progress-bar.danger { background-color: #ef44b9a6; } .progress-label { position: absolute; top: 0; left: 50%; transform: translateX(-50%); color: #ffffff; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); line-height: 20px; font-size: 12px; font-weight: bold; } .consistency-warning { background-color: #fef3c7; color: #92400e; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 5px solid #f59e0b; } .drawdown-info { margin-top: 10px; font-size: 0.9em; color: #b3b3b3; } .drawdown-floor-warning { color: #ef44c493; font-weight: bold; margin-top: 10px; } .settings-modal, .details-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; overflow-y: auto; } input[type="date"], input[type="time"] { background-color: #75e8ecc2; /* Fondo blanco para contraste */ color: #111111; /* Texto negro */ border: 1px solid #333333; /* Borde visible */ padding: 5px; font-size: 14px; } .modal-content { background-color: #2d2d2d; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; margin: 20px 0; border: 1px solid #4b5563; } .close-modal { float: right; cursor: pointer; font-size: 24px; font-weight: bold; color: #b3b3b3; } .close-modal:hover { color: #ffffff; } .modal-buttons { display: flex; justify-content: space-between; margin-top: 20px; } .modal-buttons button { width: 48%; } .checklist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; } #listaTareas { list-style: none; padding: 0; } #listaTareas li { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #4b5563; font-size: 18px; background-color: #1f1f1f; margin-bottom: 5px; border-radius: 5px; transition: background-color 0.3s; } #listaTareas li.completed { background-color: rgba(37, 176, 191, 0.2); } #listaTareas input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; accent-color: #10b3b9; } #listaTareas .completed span { text-decoration: line-through; color: #6b7280; } #listaTareas .ok { margin-left: auto; color: #10abb9; font-weight: bold; } .objetivos-container { display: flex; grid-template-columns: 1fr 1fr; gap: 20px; } .objetivos-form, .objetivos-list { background-color: #2d2d2d; padding: 15px; border-radius: 5px; border: 1px solid #4b5563; } .objetivos-list .entry { background-color: #1f1f1f; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #4b5563; } .objetivos-list .entry-header { display: flex; justify-content: space-between; align-items: center; } .objetivos-list .delete-entry { background-color: transparent; color: #ef44bf; border: none; cursor: pointer; font-size: 16px; } .objetivos-list .delete-entry:hover { color: #dc268d7d; } .stars { display: flex; gap: 5px; font-size: 20px; cursor: pointer; } .star.selected { color: #cfc6b7; } .media-preview { max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 5px; } .media-preview img, .media-preview video { width: 100%; height: auto; object-fit: cover; } .entry-operations { margin-top: 10px; padding: 10px; background-color: #2d2d2d; border-radius: 5px; } .entry-operations table { width: 100%; border-collapse: collapse; } .entry-operations th, .entry-operations td { padding: 8px; border-bottom: 1px solid #4b5563; } .entry-operations th { background-color: #1f1f1f; } @media (max-width: 800px) { .objetivos-container { grid-template-columns: 1fr; } } @media (max-width: 500px) { .container { padding: 15px; } h1 { font-size: 20px; } #listaTareas li { font-size: 16px; } #listaTareas input[type="checkbox"] { width: 18px; height: 18px; } .tabs { flex-direction: column; } .tab { border-bottom: 1px solid #4b5563; } .stat-box { min-width: 100%; } } .mood-input-container { position: relative; } .mood-icons { display: flex; gap: 10px; margin-top: 8px; justify-content: flex-start; } .mood-icon { font-size: 24px; cursor: pointer; padding: 5px; border-radius: 5px; transition: background-color 0.3s; user-select: none; } .mood-icon:hover { background-color: rgba(0, 242, 234, 0.2); } .show-all-selector { display: flex; justify-content: center; align-items: center; margin: 15px 0; gap: 10px; } .show-all-selector select { width: auto; padding: 8px 12px; font-size: 14px; } .percentage-50 { color: #ffffff; } .percentage-below-50 { color: #ef44bc; } .percentage-above-50 { color: #00f2ea; } /* --- ESTILOS GENERALES DE LA SECCI√ìN RETOS --- */ .week-nav { display: flex; justify-content: space-between; align-items: center; margin: 1rem 0; padding: 0 1rem; } .week-nav button { background-color: #3a3a3a; border: none; color: #b3b3b3; padding: 0.5rem 0.8rem; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; font-size: clamp(0.7rem, 2vw, 0.8rem); min-width: 60px; max-width: 80px; white-space: nowrap; } .week-nav button:hover { background-color: #00f2ea; color: #000000; } .week-nav button:disabled { opacity: 0.5; cursor: not-allowed; background-color: #2d2d2d; color: #6b7280; } .current-week { font-weight: bold; font-size: clamp(0.9rem, 3vw, 1.1rem); color: #00f2ea; text-align: center; flex: 2; margin: 0 1rem; } .reto-section { background-color: #2d2d2d; border-radius: 10px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.3); border: 1px solid #4b5563; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; } .reto-section h2 { color: #ffffff; margin-bottom: 1rem; font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: 600; width: 100%; } .reto-input { flex: 1; min-width: 200px; padding: 0.8rem; border: 1px solid #4b5563; border-radius: 4px; font-size: clamp(0.9rem, 3vw, 1rem); transition: all 0.3s ease; background-color: #1a1a1a; color: #ffffff; font-weight: 500; box-sizing: border-box; } .reto-input:focus { outline: none; border-color: #00f2ea; } .reto-input:disabled { background-color: #2d2d2d; cursor: not-allowed; opacity: 0.8; color: #6b7280; } .reto-input::placeholder { color: #6b7280; } /* --- NUEVO DISE√ëO LINEAL PARA LOS D√çAS --- */ .dias-grid { display: flex; flex-direction: column; /* Apila los d√≠as verticalmente */ gap: 0.8rem; margin: 1.8rem 0; /* Margen arriba y abajo */ background-color: #2d2d2d; padding: 1rem; border-radius: 8px; border: 1px solid #4b5563; } .dia-linea { display: grid; grid-template-columns: 100px 40px 40px 1fr; /* D√≠a | ‚úì | ‚úó | Operativa */ align-items: center; gap: 1rem; padding: 0.5rem; border-radius: 5px; transition: background-color 0.3s; } .dia-linea:hover { background-color: #3a3a3a; } .dia-nombre-lineal { font-weight: 600; color: #b3b3b3; font-size: 0.9rem; } /* --- NUEVOS ESTILOS PARA BOTONES SEPARADOS --- */ .dia-reto-controles { display: flex; gap: 0.5rem; /* Espacio entre los dos botones */ justify-content: center; } .btn-cumplido-check, .btn-no-cumplido-check { width: 32px; height: 32px; border-radius: 5px; cursor: pointer; border: 2px solid #4b5563; background-color: #3a3a3a; color: #b3b3b3; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; transition: all 0.3s; } .btn-cumplido-check.active { background-color: #10b0b9; border-color: #10b0b9; color: white; } .btn-no-cumplido-check.active { background-color: #ef44bc; border-color: #ef44bc; color: white; } .resultado-selector-lineal select { width: 100%; max-width: 150px; padding: 0.5rem; font-size: 0.85rem; background-color: #1a1a1a; color: #ffffff; border: 1px solid #4b5563; border-radius: 4px; } /* --- ESTILOS PARA ESTAD√çSTICAS, HISTORIAL Y OTROS --- */ .estadisticas { background-color: #2d2d2d; border-radius: 10px; padding: 1.5rem; margin-top: 1.8rem; /* A√±adido para separar de los d√≠as */ box-shadow: 0 2px 10px rgba(0,0,0,0.3); border: 1px solid #4b5563; } .estadisticas h2 { color: #ffffff; margin-bottom: 1.2rem; font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: 600; } .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; } .stat-card { text-align: center; padding: 1.2rem; background-color: #1f1f1f; border-radius: 5px; transition: all 0.3s ease; border: 1px solid #4b5563; } .stat-card:hover { transform: translateY(-0.1rem); box-shadow: 0 4px 15px rgba(0, 242, 234, 0.2); } .stat-number { font-size: clamp(1.5rem, 5vw, 1.8rem); font-weight: 700; color: #00f2ea; margin-bottom: 0.3rem; } .stat-label { font-size: clamp(0.75rem, 2.5vw, 0.85rem); color: #b3b3b3; font-weight: 500; } .chart-container { position: relative; height: 300px; background-color: #1f1f1f; border-radius: 5px; padding: 1.5rem; margin-top: 1.5rem; /* Separaci√≥n del grid de stats */ border: 1px solid #4b5563; } .historial { background-color: #2d2d2d; border-radius: 10px; padding: 1.5rem; margin-top: 1.8rem; box-shadow: 0 2px 10px rgba(0,0,0,0.3); border: 1px solid #4b5563; } .historial h2 { color: #ffffff; margin-bottom: 1.2rem; font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: 600; } .historial-item { padding: 1rem; border-bottom: 1px solid #4b5563; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; transition: all 0.3s ease; border-radius: 5px; margin-bottom: 0.3rem; } .historial-item:hover { background-color: #1f1f1f; transform: translateX(0.3rem); } .historial-item:last-child { border-bottom: none; } .historial-fecha { font-weight: 600; color: #00f2ea; font-size: clamp(0.9rem, 3vw, 1rem); } .historial-stats { font-size: clamp(0.8rem, 2.5vw, 0.9rem); color: #b3b3b3; margin-top: 0.2rem; } .historial-reto { font-size: clamp(0.7rem, 2vw, 0.8rem); color: #b3b3b3; margin-top: 0.3rem; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; } .btn-ver-semana, .btn-eliminar-semana { background-color: #00f2ea; color: #000000; border: none; padding: 0.6rem 1rem; border-radius: 4px; cursor: pointer; font-size: clamp(0.7rem, 2vw, 0.8rem); font-weight: 500; transition: all 0.3s ease; margin: 0.2rem; } .btn-eliminar-semana { background-color: #ef44bc; color: #ffffff; } .btn-ver-semana:hover { background-color: #00d4d1; transform: translateY(-1px); } .btn-eliminar-semana:hover { background-color: #dc2693; transform: translateY(-1px); } .guardar-section { text-align: center; margin: 1.5rem 0; padding: 1.2rem; } .btn-finalizar { background-color: #00f2ea; color: #000000; border: none; padding: clamp(0.8rem, 3vw, 1rem) clamp(1.2rem, 4vw, 1.8rem); border-radius: 4px; font-size: clamp(0.85rem, 3vw, 1rem); font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(0, 242, 234, 0.3); min-width: clamp(150px, 40vw, 200px); display: none; } .btn-finalizar:hover { background-color: #00d4d1; transform: translateY(-1px); } .btn-editar-reto, .btn-guardar-reto { background-color: #00f2ea; color: #000000; border: none; padding: 0.8rem; border-radius: 4px; cursor: pointer; font-size: clamp(0.8rem, 2.5vw, 0.9rem); transition: all 0.3s ease; min-width: 3rem; display: none; align-items: center; justify-content: center; } .btn-editar-reto:hover, .btn-guardar-reto:hover { background-color: #00d4d1; transform: translateY(-1px); } .btn-guardar-reto { background-color: #10b0b9; color: #ffffff; } .btn-guardar-reto:hover { background-color: #0e9da6; } .monthly-stats { background-color: #2d2d2d; border-radius: 10px; padding: 1.5rem; margin-top: 1.8rem; box-shadow: 0 2px 10px rgba(0,0,0,0.3); border: 1px solid #4b5563; } .month-selector { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1.2rem; margin-bottom: 1.5rem; } .month-selector button { background-color: #00f2ea; color: #000000; border: none; padding: 0.6rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; font-size: clamp(0.8rem, 2.5vw, 0.9rem); } .month-selector button:hover { background-color: #00d4d1; transform: translateY(-1px); } .progress-fill { height: 100%; background-color: #10b0b9; transition: width 0.5s ease; border-radius: 5px; } /* --- Media Queries para Responsividad --- */ @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); } .month-selector { flex-direction: column; gap: 0.8rem; } .reto-section { flex-direction: column; } .reto-input { min-width: 100%; } .btn-editar-reto, .btn-guardar-reto { width: 100%; } } @media (max-width: 500px) { .dia-linea { grid-template-columns: 80px 35px 1fr; /* Ajuste para m√≥viles */ gap: 0.8rem; } .btn-finalizar { padding: 0.6rem 1rem; font-size: clamp(0.75rem, 2.5vw, 0.9rem); min-width: 120px; } } /* --- A√ëADE ESTAS REGLAS PARA LOS T√çTULOS --- */ .dias-grid-header { display: grid; grid-template-columns: 100px 90px 90px 1fr; /* D√≠a | ‚úì | ‚úó | Operativa */ align-items: center; gap: 1rem; padding: 0 0.5rem 0.5rem; /* Padding solo abajo */ border-bottom: 1px solid #4b5563; /* L√≠nea separadora */ margin-bottom: 0.5rem; } .dias-grid-header span { font-size: 0.8rem; font-weight: bold; color: #b3b3b3; text-transform: uppercase; text-align: center; } /* Alineamos el primer t√≠tulo (D√≠a) a la izquierda */ .dias-grid-header span:first-child { text-align: left; } /* --- REGLA A√ëADIDA --- */ /* Alineamos el √∫ltimo t√≠tulo (Operativa) a la izquierda para que coincida con el selector */
Trading Control

b
Nueva Cuenta
Eliminar
Dashboard
Checklist
Registro
Historial
Objetivos
Retos Semanales
Resumen de Cuenta
Saldo Inicial
50000.00 ‚Ç¨

Saldo Actual
50000.00 ‚Ç¨

Ganancia/P√©rdida
0.00 ‚Ç¨

Rentabilidad
0.00%

Ajustes
Seguimiento de Drawdown
Pico de Saldo (HWM)
50000.00 ‚Ç¨

Suelo Drawdown
47500.00 ‚Ç¨

Margen hasta Suelo
2500.00 ‚Ç¨

El suelo de drawdown es el saldo m√≠nimo permitido.

Regla de Consistencia
El d√≠a m√°s rentable no debe superar el 40% de las ganancias totales.

0%
No hay suficientes datos para calcular la consistencia.

Objetivos
Objetivo Semanal
0.00 ‚Ç¨

0.00%

Objetivo Mensual
0.00 ‚Ç¨

0.00%

Metas
¬°No tienes metas pendientes! Buen trabajo.

Crecimiento de Capital y Seguimiento de Drawdown
Operaciones Recientes
No hay operaciones recientes para mostrar.

const ACTIVE_ACCOUNT_KEY = 'tradingActiveAccount'; function getChecklistItemsForAccount() { const key = `checklist_items_${currentAccountId}`; const storedItems = localStorage.getItem(key); if (storedItems) { return JSON.parse(storedItems); } else { // Lista por defecto para cuentas nuevas return [ "RITHMIC (CORTAFUEGO)", "NINJA CUENTA REAL", "REPLICADOR Y GESTOR", "NOTICIAS", "LECTURA DEL MERCADO", "ATM CORRECTOS", "GRAFICA", "DIARIO DE TRADING", "REVISI√ìN" ]; } } // --- State --- let accounts = []; let currentAccountId = null; let operations = []; let settings = { initialBalance: 50000, consistencyPercentage: 40, trailingDrawdownAmount: 2500 }; let journals = []; let goals = { weekly: 0, monthly: 0 }; let highWaterMark = 0; let drawdownFloor = 0; let showAllOperations = false; // --- Helpers --- function formatCurrency(value) { return (typeof value === 'number' ? value.toFixed(2) : '0.00') + ' ‚Ç¨'; } function formatPercentage(value) { return (typeof value === 'number' ? value.toFixed(2) : '0.00') + '%'; } function formatDate(dateString) { if (!dateString) return 'N/A'; try { return new Date(dateString + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }); } catch (e) { return 'Fecha Inv√°lida'; } } function formatType(type) { switch (type) { case 'bullish': return 'Alcista'; case 'bearish': return 'Bajista'; case 'other': return 'Otro'; default: return 'N/A'; } } function parseAmount(value) { if (typeof value !== 'string') return NaN; const cleanedValue = value.replace(/\s/g, '').replace(',', '.'); const number = parseFloat(cleanedValue); return isNaN(number) ? NaN : number; } function calculateDuration(entryTime, exitTime) { if (!entryTime || !exitTime) return 'N/A'; entryTime = entryTime.split(':').length === 2 ? entryTime + ':00' : entryTime; exitTime = exitTime.split(':').length === 2 ? exitTime + ':00' : exitTime; if (!/^\d{2}:\d{2}:\d{2}$/.test(entryTime) || !/^\d{2}:\d{2}:\d{2}$/.test(exitTime)) return 'Formato Inv√°lido'; try { const [entryH, entryM, entryS] = entryTime.split(':').map(Number); const [exitH, exitM, exitS] = exitTime.split(':').map(Number); let durationS = (exitH * 3600 + exitM * 60 + exitS) - (entryH * 3600 + entryM * 60 + entryS); if (durationS < 0) return 'Revisar Horas'; const h = Math.floor(durationS / 3600), m = Math.floor((durationS % 3600) / 60), s = durationS % 60; return `${h}h ${m}m ${s}s`; } catch (e) { return 'Error C√°lculo'; } } function readFileAsDataURL(file, callback) { if (!file) { return callback(null); } // --- L√≥gica de Compresi√≥n de Im√°genes --- // Si el archivo es una imagen, la procesamos. Si es un v√≠deo, lo ignoramos. if (file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = function(event) { const img = new Image(); img.src = event.target.result; img.onload = function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); // Define las nuevas dimensiones m√°ximas const MAX_WIDTH = 800; const MAX_HEIGHT = 600; let width = img.width; let height = img.height; // Calcula las nuevas dimensiones manteniendo la proporci√≥n if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } } canvas.width = width; canvas.height = height; // Dibuja la imagen redimensionada en el canvas ctx.drawImage(img, 0, 0, width, height); // Convierte el canvas a un DataURL de imagen JPG con calidad del 75% // El formato 'image/jpeg' es m√°s eficiente en espacio que 'image/png' const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.75); // Devuelve la imagen comprimida callback(compressedDataUrl); }; }; reader.readAsDataURL(file); } else if (file.type.startsWith('video/')) { // Si es un v√≠deo, avisamos que no se puede y lo descartamos. alert('Los v√≠deos no se pueden adjuntar para ahorrar espacio. Por favor, a√±ade una referencia en las notas.'); callback(null); // Devolvemos null para que no se guarde nada. return; } else { // Si no es ni imagen ni v√≠deo, lo ignoramos. callback(null); } } function getWeekNumber(date) { const d = new Date(date); d.setHours(0, 0, 0, 0); d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7); const week1 = new Date(d.getFullYear(), 0, 4); return Math.round(((d - week1) / 86400000 + 1) / 7) + 1; } function getDayOfWeek(dateString) { const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado']; return days[new Date(dateString).getDay()]; } // --- Checklist --- function getChecklistKey() { const today = new Date().toISOString().split('T')[0]; return `checklist_${currentAccountId}_${today}`; } function showChecklist(isEditMode = false) { const checklistItems = getChecklistItemsForAccount(); const checklistKey = getChecklistKey(); // Clave para el estado (marcado/no marcado) let estadoTareas = JSON.parse(localStorage.getItem(checklistKey)) || checklistItems.map(() => false); const lista = document.getElementById('listaTareas'); lista.innerHTML = ''; checklistItems.forEach((tarea, index) => { const li = document.createElement('li'); li.className = estadoTareas[index] ? 'completed' : ''; if (isEditMode) { // MODO EDICI√ìN: Muestra un campo de texto y un bot√≥n de borrar li.innerHTML = ` 
${tarea}
 Eliminar `; } else { // MODO NORMAL: Muestra el checkbox y el texto li.innerHTML = `  ${tarea} ${estadoTareas[index] ? 'OK' : ''} `; } lista.appendChild(li); }); } // Variable para controlar el estado de edici√≥n let isChecklistEditMode = false; function toggleChecklistEditMode() { isChecklistEditMode = !isChecklistEditMode; // Invierte el estado (true/false) // Muestra u oculta los botones y el formulario de a√±adir tarea document.getElementById('edit-checklist-btn').style.display = isChecklistEditMode ? 'none' : 'inline-block'; document.getElementById('save-checklist-btn').style.display = isChecklistEditMode ? 'inline-block' : 'none'; document.getElementById('add-task-container').style.display = isChecklistEditMode ? 'block' : 'none'; // Vuelve a dibujar el checklist en el modo correspondiente showChecklist(isChecklistEditMode); } function saveChecklistChanges() { const inputs = document.querySelectorAll('.checklist-edit-input'); const newChecklistItems = []; inputs.forEach(input => { newChecklistItems.push(input.value); }); // Guarda la nueva lista personalizada en el localStorage const key = `checklist_items_${currentAccountId}`; localStorage.setItem(key, JSON.stringify(newChecklistItems)); // Sal del modo edici√≥n toggleChecklistEditMode(); alert('¬°Lista de tareas guardada!'); } function addNewChecklistItem() { const input = document.getElementById('new-task-input'); const newTaskText = input.value.trim(); if (newTaskText) { const currentItems = getChecklistItemsForAccount(); currentItems.push(newTaskText); // Guarda la lista actualizada temporalmente para que se muestre const key = `checklist_items_${currentAccountId}`; localStorage.setItem(key, JSON.stringify(currentItems)); input.value = ''; // Limpia el campo showChecklist(true); // Refresca la vista en modo edici√≥n } } function removeChecklistItem(indexToRemove) { if (confirm('¬øSeguro que quieres eliminar esta tarea de la lista?')) { let currentItems = getChecklistItemsForAccount(); // Filtra el array para quitar el elemento en la posici√≥n 'indexToRemove' currentItems = currentItems.filter((_, index) => index !== indexToRemove); const key = `checklist_items_${currentAccountId}`; localStorage.setItem(key, JSON.stringify(currentItems)); showChecklist(true); // Refresca la vista en modo edici√≥n } } function markChecklistItem(index, checkbox) { const checklistKey = getChecklistKey(); const items = getChecklistItemsForAccount(); let estadoTareas = JSON.parse(localStorage.getItem(checklistKey)) || items.map(() => false); estadoTareas[index] = checkbox.checked; localStorage.setItem(checklistKey, JSON.stringify(estadoTareas)); showChecklist(); } function resetChecklist() { const checklistKey = getChecklistKey(); localStorage.removeItem(checklistKey); showChecklist(); } // --- Persistence and Accounts --- function getOperationsKey(accountId) { return `tradingOperations_${accountId}`; } function getSettingsKey(accountId) { return `tradingSettings_${accountId}`; } function getJournalsKey(accountId) { return `tradingJournals_${accountId}`; } function getGoalsKey(accountId) { return `tradingGoals_${accountId}`; } function loadAccounts() { try { const stored = localStorage.getItem(ACCOUNTS_KEY); accounts = stored ? JSON.parse(stored) : []; } catch (e) { console.error("Error loading accounts:", e); accounts = []; } } function saveAccounts() { try { localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(accounts)); } catch (e) { console.error("Error saving accounts:", e); } } function populateAccountSelector() { const sel = document.getElementById('account-selector'); sel.innerHTML = ''; accounts.forEach(acc => { const opt = document.createElement('option'); opt.value = acc.id; opt.textContent = acc.name; sel.appendChild(opt); }); if (currentAccountId) { sel.value = currentAccountId; } } function setActiveAccount(id) { currentAccountId = id; localStorage.setItem(ACTIVE_ACCOUNT_KEY, currentAccountId); const settingsKey = getSettingsKey(currentAccountId); const storedSettings = localStorage.getItem(settingsKey); settings = storedSettings ? JSON.parse(storedSettings) : { initialBalance: 50000, consistencyPercentage: 40, trailingDrawdownAmount: 2500 }; const opsKey = getOperationsKey(currentAccountId); const storedOperations = localStorage.getItem(opsKey); operations = storedOperations ? JSON.parse(storedOperations) : []; operations.sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00:00'))); const journalsKey = getJournalsKey(currentAccountId); const storedJournals = localStorage.getItem(journalsKey); journals = storedJournals ? JSON.parse(storedJournals) : []; const goalsKey = getGoalsKey(currentAccountId); const storedGoals = localStorage.getItem(goalsKey); goals = storedGoals ? JSON.parse(storedGoals) : { weekly: 0, monthly: 0 }; calculateHwmAndDrawdownFloor(true); populateAccountSelector(); // Recargar retos semanales si ya est√° inicializada la clase if (window.app) { window.app.reloadForAccount(); } updateUI(); } function openCreateAccountModal() { const name = prompt('Introduce nombre de la nueva cuenta:'); if (!name) return; const id = Date.now().toString(); accounts.push({ id: id, name: name }); saveAccounts(); setActiveAccount(id); alert('Cuenta creada. Ajusta la configuraci√≥n de la cuenta si es necesario.'); openSettingsModal(); } function confirmDeleteAccount() { if (!currentAccountId) return; const currentAccount = accounts.find(a => a.id === currentAccountId); if (!currentAccount) return; if (accounts.length === 1) { alert('No puedes eliminar la √∫nica cuenta.'); return; } if (confirm('¬øEliminar cuenta "' + currentAccount.name + '"? Esta acci√≥n eliminar√° todas sus operaciones, diarios y objetivos.')) { localStorage.removeItem(getOperationsKey(currentAccountId)); localStorage.removeItem(getSettingsKey(currentAccountId)); localStorage.removeItem(getJournalsKey(currentAccountId)); localStorage.removeItem(getGoalsKey(currentAccountId)); accounts = accounts.filter(a => a.id !== currentAccountId); saveAccounts(); if (accounts.length > 0) { setActiveAccount(accounts[0].id); } else { const id = Date.now().toString(); accounts = [{ id: id, name: 'Cuenta 1' }]; saveAccounts(); setActiveAccount(id); } alert('Cuenta eliminada.'); } } function saveData() { if (!currentAccountId) return; try { localStorage.setItem(getOperationsKey(currentAccountId), JSON.stringify(operations)); localStorage.setItem(getSettingsKey(currentAccountId), JSON.stringify(settings)); localStorage.setItem(getJournalsKey(currentAccountId), JSON.stringify(journals)); localStorage.setItem(getGoalsKey(currentAccountId), JSON.stringify(goals)); localStorage.setItem(ACTIVE_ACCOUNT_KEY, currentAccountId); } catch (e) { console.error("Error saving data:", e); alert("Error al guardar datos."); } } // --- Tabs --- function openTab(tabName) { const tabContents = document.querySelectorAll('.tab-content'); const tabs = document.querySelectorAll('.tab'); tabContents.forEach(el => el.classList.remove('active')); tabs.forEach(el => el.classList.remove('active')); const tabElement = document.getElementById(tabName); const activeButton = document.querySelector(`.tab[onclick="openTab('${tabName}')"]`); if (tabElement) tabElement.classList.add('active'); if (activeButton) activeButton.classList.add('active'); if (tabName === 'Retos' && typeof app === 'undefined') { window.app = new RetosSemanales();} if (tabName === 'checklist') showChecklist(); else if (tabName === 'historial') { populateYearFilter(); renderOperations(); } else if (tabName === 'dashboard') updateDashboard(); else if (tabName === 'objetivos') { document.getElementById('journal-date').value = new Date().toISOString().split('T')[0]; document.getElementById('weekly-goal').value = goals.weekly || ''; document.getElementById('monthly-goal').value = goals.monthly || ''; updateJournalStatistics(); showJournalEntries(); updateGoalProgress(); } } // --- Modals --- function openSettingsModal() { document.getElementById('initial-balance').value = settings.initialBalance; document.getElementById('consistency-percentage').value = settings.consistencyPercentage; document.getElementById('trailing-drawdown-amount').value = settings.trailingDrawdownAmount; document.getElementById('settings-modal').style.display = 'flex'; } function closeSettingsModal() { document.getElementById('settings-modal').style.display = 'none'; } function openDetailsModal() { document.getElementById('details-modal').style.display = 'flex'; } function closeDetailsModal() { document.getElementById('details-modal').style.display = 'none'; } function saveSettings() { const ib = parseFloat(document.getElementById('initial-balance').value); const cp = parseInt(document.getElementById('consistency-percentage').value); const tda = parseFloat(document.getElementById('trailing-drawdown-amount').value); if (isNaN(ib) || ib < 0) { alert('Saldo inicial inv√°lido.'); return; } if (isNaN(cp) || cp < 1 || cp > 100) { alert('% Consistencia inv√°lido (1-100).'); return; } if (isNaN(tda) || tda <= 0) { alert('Importe Drawdown inv√°lido (>0).'); return; } settings.initialBalance = ib; settings.consistencyPercentage = cp; settings.trailingDrawdownAmount = tda; calculateHwmAndDrawdownFloor(true); saveData(); closeSettingsModal(); updateUI(); alert('Configuraci√≥n guardada.'); } function resetAllData() { if (confirm('¬øReiniciar TODAS las operaciones, diarios y objetivos? (Configuraci√≥n se mantiene)')) { operations = []; journals = []; goals = { weekly: 0, monthly: 0 }; highWaterMark = settings.initialBalance; drawdownFloor = settings.initialBalance - settings.trailingDrawdownAmount; localStorage.removeItem(getOperationsKey(currentAccountId)); localStorage.removeItem(getJournalsKey(currentAccountId)); localStorage.removeItem(getGoalsKey(currentAccountId)); saveData(); updateUI(); alert('Datos reiniciados.'); } } // --- Operations --- document.getElementById('trading-form').addEventListener('submit', function(e) { e.preventDefault(); const dateInput = document.getElementById('date'); const typeInput = document.getElementById('type'); const activoSelect = document.getElementById('activo'); const customActivoInput = document.getElementById('custom-activo-input'); const estrategiaSelect = document.getElementById('estrategia'); const customEstrategiaInput = document.getElementById('custom-estrategia-input'); const contractsInput = document.getElementById('contracts'); const entryTimeInput = document.getElementById('entry-time'); const exitTimeInput = document.getElementById('exit-time'); const amountInput = document.getElementById('amount'); const entryTypeSelect = document.getElementById('entry-type'); const customEntryTypeInput = document.getElementById('custom-entry-type-input'); const exitTypeSelect = document.getElementById('exit-type'); const customExitTypeInput = document.getElementById('custom-exit-type-input'); const mediaInput = document.getElementById('trade-media'); const notesInput = document.getElementById('notes'); const moodInput = document.getElementById('journal-mood'); const newsRatingInput = document.getElementById('journal-news'); const date = dateInput.value; const type = typeInput.value || null; let activo = activoSelect.value; if (activo === 'custom') { activo = customActivoInput.value.trim(); } let estrategia = estrategiaSelect.value; if (estrategia === 'custom') { estrategia = customEstrategiaInput.value.trim(); } const contracts = parseInt(contractsInput.value) || null; let entryType = entryTypeSelect.value; if (entryType === 'custom') { entryType = customEntryTypeInput.value.trim(); } let exitType = exitTypeSelect.value; if (exitType === 'custom') { exitType = customExitTypeInput.value.trim(); } const entryTime = entryTimeInput.value || null; const exitTime = exitTimeInput.value || null; const amount = parseAmount(amountInput.value); const notes = notesInput.value.trim(); const mood = moodInput.value.trim(); const newsRating = parseInt(newsRatingInput.value) || 0; if (!date || isNaN(amount)) { alert('Introduce Fecha e Importe v√°lidos (Ej: 150.50 o -75.20).'); if (!date) dateInput.focus(); else amountInput.focus(); return; } if (entryTime && !/^\d{2}:\d{2}(:\d{2})?$/.test(entryTime)) { alert('Formato hora entrada inv√°lido.'); return; } if (exitTime && !/^\d{2}:\d{2}(:\d{2})?$/.test(exitTime)) { alert('Formato hora salida inv√°lido.'); return; } readFileAsDataURL(mediaInput.files[0], (mediaData) => { const operation = { numero_de_trade: Date.now(), id: Date.now(), fecha_de_operacion: date, instrumento: activo || 'N/A', cuenta: currentAccountId, mercado_pos: type === 'bullish' ? 'Long' : (type === 'bearish' ? 'Short' : null), cant: contracts, precio_de_entrada: null, precio_de_salida: null, tiempo_de_entrada: entryTime, tiempo_de_salida: exitTime, con_ganancia_neto: amount, estrategia_manual: estrategia || 'N/A', tipo_entrada_manual: entryType || null, tipo_salida_manual: exitType || null, estado_animo: mood, valoracion_noticias: newsRating, notas_psicologia: notes, media: mediaData, date: date, type: type, activo: activo || 'N/A', estrategia: estrategia || 'N/A', contracts: contracts, entryType: entryType || null, exitType: exitType || null, entryTime: entryTime, exitTime: exitTime, duration: calculateDuration(entryTime, exitTime), amount: amount, notes: notes, mood: mood, newsRating: newsRating }; operations.push(operation); operations.sort((a, b) => new Date(a.fecha_de_operacion + 'T' + (a.tiempo_de_entrada || '00:00:00')) - new Date(b.fecha_de_operacion + 'T' + (b.tiempo_de_entrada || '00:00:00'))); calculateHwmAndDrawdownFloor(); saveData(); alert('Operaci√≥n guardada.'); document.getElementById('trading-form').reset(); document.getElementById('date').value = new Date().toISOString().split('T')[0]; document.getElementById('custom-activo-input').style.display = 'none'; document.getElementById('custom-estrategia-input').style.display = 'none'; document.getElementById('custom-entry-type-input').style.display = 'none'; document.getElementById('custom-exit-type-input').style.display = 'none'; setNewsRating(0); updateUI(); }); }); function deleteOperation(id) { if (confirm('¬øEliminar esta operaci√≥n?')) { operations = operations.filter(op => op.id !== id); calculateHwmAndDrawdownFloor(); saveData(); updateUI(); alert('Operaci√≥n eliminada.'); } } function setMood(mood) { document.getElementById('journal-mood').value = mood; } // --- Asset Selection --- function handleAssetSelection(selectElement) { const selectedValue = selectElement.value; let customInputId; if (selectElement.id === 'activo') { customInputId = 'custom-activo-input'; } else if (selectElement.id === 'estrategia') { customInputId = 'custom-estrategia-input'; } else if (selectElement.id === 'entry-type') { customInputId = 'custom-entry-type-input'; } else if (selectElement.id === 'exit-type') { customInputId = 'custom-exit-type-input'; } const customInput = document.getElementById(customInputId); if (selectedValue === 'custom') { customInput.style.display = 'block'; customInput.focus(); } else { customInput.style.display = 'none'; customInput.value = ''; } } // --- Drawdown Logic --- function calculateHwmAndDrawdownFloor(fullRecalculate = false) { let currentBalance = settings.initialBalance; let peakBalance = settings.initialBalance; let calculatedFloor = settings.initialBalance - settings.trailingDrawdownAmount; const bufferThreshold = settings.initialBalance + settings.trailingDrawdownAmount; let floorIsFixed = false; let historicalPeak = settings.initialBalance; for (const op of operations) { historicalPeak += op.con_ganancia_neto || op.amount || 0; if (historicalPeak >= bufferThreshold) { floorIsFixed = true; break; } } if (floorIsFixed) { calculatedFloor = settings.initialBalance; } else { currentBalance = settings.initialBalance; peakBalance = settings.initialBalance; operations.forEach(op => { currentBalance += op.con_ganancia_neto || op.amount || 0; if (currentBalance > peakBalance) { peakBalance = currentBalance; } }); calculatedFloor = peakBalance - settings.trailingDrawdownAmount; } let runningBalance = settings.initialBalance; highWaterMark = settings.initialBalance; operations.forEach(op => { runningBalance += op.con_ganancia_neto || op.amount || 0; highWaterMark = Math.max(highWaterMark, runningBalance); }); drawdownFloor = Math.max(calculatedFloor, settings.initialBalance - settings.trailingDrawdownAmount); if (floorIsFixed) { drawdownFloor = Math.min(drawdownFloor, settings.initialBalance); } } // --- Journals --- function setNewsRating(value) { const stars = document.querySelectorAll('.star'); stars.forEach(star => { star.classList.remove('selected'); if (parseInt(star.dataset.value) <= value) { star.classList.add('selected'); } }); document.getElementById('journal-news').value = value; } function showJournalEntries() { const entriesContainer = document.getElementById('journal-entries'); entriesContainer.innerHTML = ''; // Filtramos para obtener SOLO las metas que NO est√°n conseguidas. const activeJournals = journals.filter(entry => !entry.achieved); if (activeJournals.length === 0) { entriesContainer.innerHTML = '
¬°No tienes metas pendientes! Buen trabajo.

'; return; } // Ordenamos por fecha activeJournals.sort((a, b) => new Date(b.date) - new Date(a.date)); activeJournals.forEach(entry => { const div = document.createElement('div'); div.className = 'entry'; div.innerHTML = `
 ${entry.title} ‚úï
Fecha: ${formatDate(entry.date)}

`; entriesContainer.appendChild(div); }); } function saveJournalEntry() { const date = document.getElementById('journal-date').value; const title = document.getElementById('journal-title').value.trim(); if (!date || !title) { alert('Por favor, completa la fecha y el t√≠tulo de la meta.'); return; } // Creamos un objeto simple para la meta const entry = { id: Date.now(), date: date, title: title, achieved: false // Nuevo estado para saber si se ha conseguido }; journals.push(entry); // 'journals' ahora almacenar√° nuestras metas saveData(); // Guardamos los datos en el LocalStorage // Limpiamos los campos del formulario document.getElementById('journal-title').value = ''; // Actualizamos la interfaz de usuario para mostrar la nueva meta updateUI(); alert('Meta guardada correctamente.'); } function deleteJournalEntry(id) { if (confirm('¬øEliminar esta entrada?')) { journals = journals.filter(entry => entry.id !== id); saveData(); showJournalEntries(); } } function renderAchievedGoals() { const container = document.getElementById('historial-metas-conseguidas'); container.innerHTML = ''; // Filtramos para obtener SOLO las metas que S√ç est√°n conseguidas. const achievedJournals = journals.filter(entry => entry.achieved); if (achievedJournals.length === 0) { container.innerHTML = '
A√∫n no has completado ninguna meta.

'; return; } // Ordenamos por fecha achievedJournals.sort((a, b) => new Date(b.date) - new Date(a.date)); achievedJournals.forEach(entry => { const div = document.createElement('div'); div.className = 'entry completed'; // Clase para estilo // --- ¬°AQU√ç EST√Å EL CAMBIO CLAVE! --- // Hemos reemplazado el  por un icono de check visual. // Este icono no es interactivo, por lo que no puedes desmarcarlo. div.innerHTML = `
‚úî ${entry.title} ‚úï
Conseguida: ${formatDate(entry.date)}

`; container.appendChild(div); }); } function saveGoals() { const weeklyGoal = parseFloat(document.getElementById('weekly-goal').value) || 0; const monthlyGoal = parseFloat(document.getElementById('monthly-goal').value) || 0; if (weeklyGoal < 0 || monthlyGoal < 0) { alert('Los objetivos deben ser valores positivos.'); return; } goals.weekly = weeklyGoal; goals.monthly = monthlyGoal; saveData(); updateUI(); alert('Objetivos guardados.'); } function updateJournalStatistics() { const cont = document.getElementById('journal-stats-container'); cont.innerHTML = ''; if (operations.length === 0) { cont.innerHTML = '
No hay operaciones.

'; return; } const tOps = operations.length; const wOps = operations.filter(op => (op.con_ganancia_neto || op.amount) > 0); const lOps = operations.filter(op => (op.con_ganancia_neto || op.amount) < 0); const nOps = operations.filter(op => (op.con_ganancia_neto || op.amount) === 0); const tWins = wOps.length; const tLosses = lOps.length; const tProfit = wOps.reduce((s, op) => s + (op.con_ganancia_neto || op.amount), 0); const tLoss = lOps.reduce((s, op) => s + (op.con_ganancia_neto || op.amount), 0); const netP = tProfit + tLoss; const winR = (tWins + tLosses) > 0 ? (tWins / (tWins + tLosses) * 100) : 0; const avgW = tWins > 0 ? tProfit / tWins : 0; const avgL = tLosses > 0 ? tLoss / tLosses : 0; const pF = (tLoss !== 0) ? Math.abs(tProfit / tLoss) : (tProfit > 0 ? Infinity : 0); let tDurS = 0, vDurCnt = 0; operations.forEach(op => { const dur = calculateDuration(op.tiempo_de_entrada || op.entryTime, op.tiempo_de_salida || op.exitTime); if (typeof dur === 'string' && dur.includes('h')) { const p = dur.match(/(\d+)h (\d+)m (\d+)s/); if (p) { tDurS += parseInt(p[1]) * 3600 + parseInt(p[2]) * 60 + parseInt(p[3]); vDurCnt++; } } }); const avgDurS = vDurCnt > 0 ? tDurS / vDurCnt : 0; const avgH = Math.floor(avgDurS / 3600), avgM = Math.floor((avgDurS % 3600) / 60), avgS = Math.floor(avgDurS % 60); const avgDurFmt = vDurCnt > 0 ? `${avgH}h ${avgM}m ${avgS}s` : 'N/A'; cont.innerHTML = `
Estad√≠sticas Generales
Total Ops
${tOps}

Ganadoras
${tWins}

Perdedoras
${tLosses}

Ratio Acierto
${(tWins + tLosses) > 0 ? formatPercentage(winR) : 'N/A'}

Beneficio Bruto
${formatCurrency(tProfit)}

P√©rdida Bruta
${(tWins + tLosses) > 0 ? formatPercentage(winR) : 'N/A'}

Beneficio Neto
${formatCurrency(netP)}

Ganancia Media
${formatCurrency(avgW)}

P√©rdida Media
${formatCurrency(Math.abs(avgL))}

Profit Factor
${pF === Infinity ? '‚àû' : pF.toFixed(2)}

Duraci√≥n Media
${avgDurFmt}

${nOps.length > 0 ? `
Neutras
${nOps.length}

` : ''}
`; } function toggleGoalAchieved(id, isAchieved) { const entry = journals.find(e => e.id === id); if (entry) { entry.achieved = isAchieved; saveData(); // Guardamos el cambio updateUI(); // Actualizamos la vista para que se vea el tachado } } // --- UI Updates --- function updateUI() { // 1. Actualiza los n√∫meros del Dashboard (saldo, P/L, etc.) updateDashboard(); // 2. Dibuja el gr√°fico de crecimiento de capital. // Esta es la l√≠nea clave que soluciona el problema. renderCapitalGrowthChart(); // Al sacar esta l√≠nea del 'if', nos aseguramos de que el Dashboard // se refresque sin importar en qu√© pesta√±a estemos. showJournalEntries(); // 3. Ahora, maneja las actualizaciones espec√≠ficas de cada pesta√±a. if (document.getElementById('checklist').classList.contains('active')) { showChecklist(); } if (document.getElementById('historial').classList.contains('active')) { populateYearFilter(); renderOperations(); // Esta ya se encarga de las metas conseguidas en el historial } if (document.getElementById('objetivos').classList.contains('active')) { document.getElementById('journal-date').value = new Date().toISOString().split('T')[0]; document.getElementById('weekly-goal').value = goals.weekly || ''; document.getElementById('monthly-goal').value = goals.monthly || ''; updateJournalStatistics(); updateGoalProgress(); renderCapitalGrowthChart(); } } function populateYearFilter() { const sel = document.getElementById('filter-year'); const cur = sel.value; const years = new Set(operations.map(op => op.date.substring(0, 4))); years.add(new Date().getFullYear().toString()); const sorted = Array.from(years).sort((a, b) => b - a); while (sel.options.length > 1) sel.remove(1); sorted.forEach(y => { const o = document.createElement('option'); o.value = y; o.textContent = y; sel.appendChild(o); }); sel.value = sorted.includes(cur) ? cur : ''; } // --- Historial Operations --- function renderOperations(filteredOps = null) { const list = document.getElementById('operations-list'); list.innerHTML = ''; const ops = filteredOps || operations; if (ops.length === 0) { list.innerHTML = 'No hay operaciones para mostrar.'; renderAchievedGoals(); return; } // Ordenar operaciones const sortedOps = ops.sort((a, b) => { const dateA = new Date(a.fecha_de_operacion || a.date + 'T' + (a.tiempo_de_entrada || a.entryTime || '00:00:00')); const dateB = new Date(b.fecha_de_operacion || b.date + 'T' + (b.tiempo_de_entrada || b.entryTime || '00:00:00')); return dateB - dateA || b.id - a.id; }); // Decidir cu√°ntas operaciones mostrar const displayLimit = parseInt(document.getElementById('operations-display').value); const opsToShow = displayLimit === -1 ? sortedOps : sortedOps.slice(0, displayLimit); // Renderizar operaciones opsToShow.forEach(op => { const tr = document.createElement('tr'); const displayAmount = op.con_ganancia_neto !== undefined ? op.con_ganancia_neto : op.amount; tr.className = displayAmount > 0 ? 'operation-bullish' : (displayAmount < 0 ? 'operation-bearish' : ''); const mediaHtml = op.media ? (op.media.startsWith('data:image') ? `` : `
`) : 'N/A'; // Formatear el mood para que solo muestre el icono let moodDisplay = op.estado_animo || op.mood || 'N/A'; if (moodDisplay.includes('üòä')) moodDisplay = 'üòä'; else if (moodDisplay.includes('üòê')) moodDisplay = 'üòê'; else if (moodDisplay.includes('üòü')) moodDisplay = 'üòü'; else if (moodDisplay.includes('üò†')) moodDisplay = 'üò†'; const displayDate = op.fecha_de_operacion || op.date; const displayInstrument = op.instrumento || op.activo || 'N/A'; const displayStrategy = op.estrategia_manual || op.estrategia || 'N/A'; const displayContracts = op.cant || op.contracts || 'N/A'; const displayEntryType = op.tipo_entrada_manual || op.entryType || 'N/A'; const displayExitType = op.tipo_salida_manual || op.exitType || 'N/A'; const displayDuration = calculateDuration(op.tiempo_de_entrada || op.entryTime, op.tiempo_de_salida || op.exitTime); tr.innerHTML = ` ${formatDate(displayDate)} ${formatType(op.mercado_pos === 'Long' ? 'bullish' : (op.mercado_pos === 'Short' ? 'bearish' : null))} ${displayInstrument} ${displayStrategy} ${displayContracts} ${displayEntryType} ${displayExitType} ${displayDuration} ${moodDisplay} ${formatCurrency(displayAmount)} ${mediaHtml} Ver Eliminar `; list.appendChild(tr); }); // Renderizar metas conseguidas renderAchievedGoals(); } function changeOperationsDisplay() { filterOperations(); // Esto llamar√° a renderOperations con la nueva configuraci√≥n } // --- Operaciones --- function showOperationDetails(id) { const op = operations.find(op => op.id === id || op.numero_de_trade === id); if (!op) return; const mediaHtml = op.media ? (op.media.startsWith('data:image') ? `` : `
`) : '
Sin media

'; // Formatear valoraci√≥n de noticias como estrellas const starsHtml = '‚òÖ'.repeat(op.valoracion_noticias || op.newsRating || 0) + '‚òÜ'.repeat(4 - (op.valoracion_noticias || op.newsRating || 0)); document.getElementById('operation-details-content').innerHTML = `
Fecha: ${formatDate(op.fecha_de_operacion || op.date)}

Tipo: ${formatType(op.mercado_pos === 'Long' ? 'bullish' : (op.mercado_pos === 'Short' ? 'bearish' : null))}

Instrumento: ${op.instrumento || op.activo || 'N/A'}

Estrategia: ${op.estrategia_manual || op.estrategia || 'N/A'}

Contratos: ${op.cant || op.contracts || 'N/A'}

Tipo de Entrada: ${op.tipo_entrada_manual || op.entryType || 'N/A'}

Tipo de Salida: ${op.tipo_salida_manual || op.exitType || 'N/A'}

Hora Entrada: ${op.tiempo_de_entrada || op.entryTime || 'N/A'}

Hora Salida: ${op.tiempo_de_salida || op.exitTime || 'N/A'}

Duraci√≥n: ${calculateDuration(op.tiempo_de_entrada || op.entryTime, op.tiempo_de_salida || op.exitTime)}

Importe: ${formatCurrency(op.con_ganancia_neto || op.amount)}

Estado de √Ånimo: ${op.estado_animo || op.mood || 'N/A'}

Valoraci√≥n Noticias: ${starsHtml}

${op.notas_psicologia || op.notes ? `
Notas:
${op.notas_psicologia || op.notes}

` : '
Sin notas.

'}
Media:
${mediaHtml}
`; openDetailsModal(); } // --- Historial Filter --- function filterOperations() { const yf = document.getElementById('filter-year').value; const mf = document.getElementById('filter-month').value; const tf = document.getElementById('filter-type').value; const rf = document.getElementById('filter-result').value; let fOps = [...operations]; if (yf) fOps = fOps.filter(op => (op.fecha_de_operacion || op.date).substring(0, 4) === yf); if (mf) fOps = fOps.filter(op => (op.fecha_de_operacion || op.date).substring(5, 7) === mf); if (tf) { if (tf === 'bullish') fOps = fOps.filter(op => op.mercado_pos === 'Long' || op.type === 'bullish'); else if (tf === 'bearish') fOps = fOps.filter(op => op.mercado_pos === 'Short' || op.type === 'bearish'); else if (tf === 'none') fOps = fOps.filter(op => !op.mercado_pos && !op.type); else fOps = fOps.filter(op => op.instrumento === tf || op.activo === tf); } if (rf) { fOps = fOps.filter(op => { const amount = op.con_ganancia_neto !== undefined ? op.con_ganancia_neto : op.amount; if (rf === 'win') return amount > 0; if (rf === 'loss') return amount < 0; if (rf === 'neutral') return amount === 0; return true; }); } renderOperations(fOps); } function updateGoalProgress() { const today = new Date(); const year = today.getFullYear(); const month = today.getMonth() + 1; const weekNumber = getWeekNumber(today); const weeklyOps = operations.filter(op => { const opDate = new Date(op.fecha_de_operacion || op.date); return getWeekNumber(opDate) === weekNumber && opDate.getFullYear() === year; }); const monthlyOps = operations.filter(op => { const opDate = new Date(op.fecha_de_operacion || op.date); return opDate.getFullYear() === year && (opDate.getMonth() + 1) === month; }); const weeklyPL = weeklyOps.reduce((sum, op) => sum + (op.con_ganancia_neto || op.amount || 0), 0); const monthlyPL = monthlyOps.reduce((sum, op) => sum + (op.con_ganancia_neto || op.amount || 0), 0); const weeklyPerc = goals.weekly > 0 ? (weeklyPL / goals.weekly * 100) : 0; const monthlyPerc = goals.monthly > 0 ? (monthlyPL / goals.monthly * 100) : 0; // Update dashboard const weeklyPercElem = document.getElementById('weekly-progress-percentage'); const monthlyPercElem = document.getElementById('monthly-progress-percentage'); if (weeklyPercElem) { weeklyPercElem.textContent = formatPercentage(weeklyPerc); weeklyPercElem.className = getPercentageClass(weeklyPerc); } if (monthlyPercElem) { monthlyPercElem.textContent = formatPercentage(monthlyPerc); monthlyPercElem.className = getPercentageClass(monthlyPerc); } // Update objetivos const weeklyDetElem = document.getElementById('weekly-progress-detailed'); const monthlyDetElem = document.getElementById('monthly-progress-detailed'); if (weeklyDetElem) weeklyDetElem.textContent = `Progreso: ${formatCurrency(weeklyPL)} / ${formatCurrency(goals.weekly)} (${formatPercentage(weeklyPerc)})`; if (monthlyDetElem) monthlyDetElem.textContent = `Progreso: ${formatCurrency(monthlyPL)} / ${formatCurrency(goals.monthly)} (${formatPercentage(monthlyPerc)})`; } // --- Dashboard Updates --- function updateDashboard() { if (!currentAccountId) return; const initialBalance = settings.initialBalance; const totalPL = operations.reduce((sum, op) => sum + (op.con_ganancia_neto || op.amount || 0), 0); const currentBalance = initialBalance + totalPL; const roi = initialBalance > 0 ? (totalPL / initialBalance * 100) : 0; document.getElementById('initial-balance-display').textContent = formatCurrency(initialBalance); document.getElementById('current-balance').textContent = formatCurrency(currentBalance); const plElem = document.getElementById('profit-loss'); plElem.textContent = formatCurrency(totalPL); plElem.className = totalPL > 0 ? 'positive' : (totalPL < 0 ? 'negative' : ''); const roiElem = document.getElementById('roi'); roiElem.textContent = formatPercentage(roi); roiElem.className = roi > 0 ? 'positive' : (roi < 0 ? 'negative' : ''); document.getElementById('high-water-mark').textContent = formatCurrency(highWaterMark); document.getElementById('drawdown-floor').textContent = formatCurrency(drawdownFloor); const marginToFloor = currentBalance - drawdownFloor; const marginElem = document.getElementById('margin-to-floor'); marginElem.textContent = formatCurrency(marginToFloor); marginElem.className = marginToFloor > 0 ? 'positive' : 'negative'; const explanationElem = document.getElementById('drawdown-explanation'); if (currentBalance < drawdownFloor) { explanationElem.innerHTML += '
¬°Advertencia: Saldo por debajo del suelo de drawdown!

'; } document.getElementById('consistency-limit-display').textContent = settings.consistencyPercentage; updateConsistencyRule(); document.getElementById('weekly-goal-display').textContent = formatCurrency(goals.weekly); document.getElementById('monthly-goal-display').textContent = formatCurrency(goals.monthly); updateGoalProgress(); updateWeeklyPerformance(); renderWeeklySuccessRate(); updateRecentOperations(); renderCapitalGrowthChart(); showJournalEntries(); } function updateConsistencyRule() { const dailyProfits = {}; operations.forEach(op => { const date = op.fecha_de_operacion || op.date; if (!dailyProfits[date]) dailyProfits[date] = 0; dailyProfits[date] += (op.con_ganancia_neto || op.amount || 0); }); const positiveDays = Object.values(dailyProfits).filter(p => p > 0); if (positiveDays.length === 0) { document.getElementById('consistency-details').textContent = 'No hay suficientes datos para calcular la consistencia.'; document.getElementById('consistency-progress').style.width = '0%'; return; } const maxDay = Math.max(...positiveDays); const totalPositive = positiveDays.reduce((s, p) => s + p, 0); const percentage = (maxDay / totalPositive * 100); const progress = Math.min(percentage / settings.consistencyPercentage * 100, 100); const bar = document.getElementById('consistency-progress'); bar.style.width = `${progress}%`; bar.className = 'progress-bar'; if (percentage > settings.consistencyPercentage) bar.classList.add('danger'); else if (percentage > settings.consistencyPercentage * 0.8) bar.classList.add('warning'); const progressLabel = document.querySelector('.progress-label'); progressLabel.textContent = formatPercentage(percentage); progressLabel.className = `progress-label ${getPercentageClass(percentage)}`; document.getElementById('consistency-details').textContent = `D√≠a m√°s rentable: ${formatCurrency(maxDay)} (${formatPercentage(percentage)}) de total ganancias ${formatCurrency(totalPositive)}`; } function updateWeeklyPerformance() { const days = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes']; const performance = Array(5).fill(0); operations.forEach(op => { let day = new Date(op.fecha_de_operacion || op.date).getDay(); if (day === 0) day = 5; // Domingo a final else day -= 1; performance[day] += (op.con_ganancia_neto || op.amount || 0); }); const container = document.getElementById('weekly-performance'); container.innerHTML = ''; days.forEach((day, index) => { const box = document.createElement('div'); box.className = 'stat-box'; box.innerHTML = `
${day}
${formatCurrency(performance[index])}

`; container.appendChild(box); }); } function renderWeeklySuccessRate() { const weeklySuccessRate = document.getElementById('weekly-success-rate'); if (!weeklySuccessRate) return; // Definir solo los d√≠as h√°biles const days = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes']; const dayStats = {}; // Inicializar estad√≠sticas solo para d√≠as h√°biles days.forEach(day => { dayStats[day] = { total: 0, wins: 0, percentage: 0 }; }); // Calcular estad√≠sticas por d√≠a operations.forEach(op => { const dayName = getDayOfWeek(op.fecha_de_operacion || op.date); // Solo procesar si el d√≠a es h√°bil if (days.includes(dayName)) { const amount = parseFloat(op.con_ganancia_neto || op.amount) || 0; dayStats[dayName].total++; if (amount > 0) { dayStats[dayName].wins++; } } }); // Calcular porcentajes Object.keys(dayStats).forEach(day => { if (dayStats[day].total > 0) { dayStats[day].percentage = (dayStats[day].wins / dayStats[day].total * 100).toFixed(1); } }); // Renderizar weeklySuccessRate.innerHTML = days.map(day => { const stats = dayStats[day]; const percentage = stats.percentage; const colorClass = percentage >= 60 ? 'positive' : percentage >= 40 ? 'warning' : 'negative'; return `
${day}
${percentage}%

${stats.wins}/${stats.total} aciertos
`; }).join(''); } function updateRecentOperations() { const recent = operations.slice(-5).reverse(); const container = document.getElementById('recent-operations'); container.innerHTML = ''; if (recent.length === 0) { container.innerHTML = '
No hay operaciones recientes para mostrar.

'; return; } const table = document.createElement('table'); table.innerHTML = 'FechaImporte'; recent.forEach(op => { const tr = document.createElement('tr'); const displayAmount = op.con_ganancia_neto !== undefined ? op.con_ganancia_neto : op.amount; tr.innerHTML = `${formatDate(op.fecha_de_operacion || op.date)}${formatCurrency(displayAmount)}`; table.querySelector('tbody').appendChild(tr); }); container.appendChild(table); } function getPercentageClass(percentage) { if (percentage === 50 || percentage === 0) { return 'percentage-50'; // Blanco } else if (percentage < 50) { return 'percentage-below-50'; // Rosa fucsia } else { return 'percentage-above-50'; // Turquesa } } // --- Gr√°fico de Crecimiento de Capital --- // --- VERSI√ìN DE DEPURACI√ìN de renderCapitalGrowthChart --- // --- Inicializaci√≥n --- loadAccounts(); const storedActive = localStorage.getItem(ACTIVE_ACCOUNT_KEY); if (storedActive && accounts.find(a => a.id === storedActive)) { setActiveAccount(storedActive); } else if (accounts.length === 0) { openCreateAccountModal(); } else { setActiveAccount(accounts[0].id); } document.getElementById('date').value = new Date().toISOString().split('T')[0]; openTab('dashboard'); // Registro del Service Worker if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js') .then((registration) => { console.log('SW registrado correctamente'); }) .catch((error) => { console.log('Error registrando SW:', error); }); }); } function renderCapitalGrowthChart() { const canvas = document.getElementById('capitalGrowthChart'); if (!canvas) { console.error("Canvas 'capitalGrowthChart' no encontrado."); return; } if (window.capitalGrowthChartInstance) { window.capitalGrowthChartInstance.destroy(); } // --- 1. Agrupar Operaciones por D√≠a --- const dailyBalances = {}; let runningBalance = settings.initialBalance; let highWaterMark = settings.initialBalance; const sortedOperations = [...operations].sort((a, b) => new Date(a.fecha_de_operacion || a.date) - new Date(b.fecha_de_operacion || b.date)); sortedOperations.forEach(op => { runningBalance += (op.con_ganancia_neto || op.amount || 0); dailyBalances[op.fecha_de_operacion || op.date] = runningBalance; highWaterMark = Math.max(highWaterMark, runningBalance); }); // --- 2. Preparar los Datos para el Gr√°fico --- const labels = []; const balanceData = []; const drawdownData = []; if (sortedOperations.length > 0) { const firstOpDate = new Date(sortedOperations[0].fecha_de_operacion || sortedOperations[0].date); firstOpDate.setDate(firstOpDate.getDate() - 1); // Un d√≠a antes para el "baj√≥n" inicial labels.push(firstOpDate.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' })); balanceData.push(settings.initialBalance); drawdownData.push(settings.initialBalance - settings.trailingDrawdownAmount); // Drawdown inicial } let currentHWM = settings.initialBalance; for (const date in dailyBalances) { labels.push(new Date(date).toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' })); balanceData.push(dailyBalances[date]); currentHWM = Math.max(currentHWM, dailyBalances[date]); // Actualizamos HWM hasta este punto // Calculamos el drawdown basado en el HWM actual, con l√≥gica de buffer let drawdownValue = currentHWM - settings.trailingDrawdownAmount; if (currentHWM >= settings.initialBalance + settings.trailingDrawdownAmount) { drawdownValue = settings.initialBalance; // Fijamos si supera el buffer } else { drawdownValue = Math.max(drawdownValue, settings.initialBalance - settings.trailingDrawdownAmount); // M√≠nimo permitido } drawdownData.push(drawdownValue); } // --- 3. Creaci√≥n del Gr√°fico Estilo Bulenox --- window.capitalGrowthChartInstance = new Chart(canvas.getContext('2d'), { type: 'line', data: { labels: labels, datasets: [ { label: 'Balance', data: balanceData, borderColor: '#00f2ea', backgroundColor: 'rgba(0, 242, 234, 0.1)', fill: true, tension: 0.1, pointRadius: 5, // Aumentado de 2 a 5 para puntos m√°s grandes }, { label: 'Suelo Drawdown', data: drawdownData, borderColor: '#ef44bc', borderWidth: 2, fill: false, pointRadius: 5, // Cambiado de 0 a 5 para mostrar puntos grandes } ] }, options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { ticks: { color: '#b3b3b3', maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 8 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, y: { ticks: { color: '#b3b3b3', callback: (v) => v.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' }) }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } }, plugins: { legend: { display: true, position: 'top', align: 'start', labels: { color: '#ffffff', boxWidth: 20, padding: 20 } } } } }); } class RetosSemanales { constructor() { this.currentWeek = this.getCurrentWeekKey(); this.currentMonth = new Date().getMonth(); this.currentYear = new Date().getFullYear(); this.data = this.loadData(); this.dias = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes']; this.chartInstance = null; this.monthlyChartInstance = null; this.viendoTodo = false; this.init(); } init() { this.setupEventListeners(); this.renderAll(); } setupEventListeners() { document.getElementById('prevWeek').addEventListener('click', () => this.changeWeek(-1)); document.getElementById('nextWeek').addEventListener('click', () => this.changeWeek(1)); document.getElementById('retoInput').addEventListener('input', (e) => this.updateReto(e.target.value)); document.getElementById('retoInput').addEventListener('blur', () => this.fixReto()); document.getElementById('btnGuardarHistorial').addEventListener('click', () => this.guardarEnHistorial()); document.getElementById('btnBorrarHistorial').addEventListener('click', () => this.borrarHistorial()); document.getElementById('btnEditarReto').addEventListener('click', () => this.editarReto()); document.getElementById('btnGuardarReto').addEventListener('click', () => this.guardarReto()); document.getElementById('prevMonthBtn').addEventListener('click', () => this.changeMonth(-1)); document.getElementById('nextMonthBtn').addEventListener('click', () => this.changeMonth(1)); document.getElementById('toggleTotalViewBtn').addEventListener('click', () => this.toggleVistaTotal()); } getRetosKey() { return `retosSemanalesData_${currentAccountId}`; } loadData() { const saved = localStorage.getItem(this.getRetosKey()); return saved ? JSON.parse(saved) : {}; } saveData() { localStorage.setItem(this.getRetosKey(), JSON.stringify(this.data)); } reloadForAccount() { this.data = this.loadData(); this.currentWeek = this.getCurrentWeekKey(); this.currentMonth = new Date().getMonth(); this.currentYear = new Date().getFullYear(); this.viendoTodo = false; this.renderAll(); } getCurrentWeekData() { if (!this.data[this.currentWeek]) { this.data[this.currentWeek] = { reto: '', retoFijo: false, completada: false, dias: {} }; this.dias.forEach(dia => { this.data[this.currentWeek].dias[dia.toLowerCase()] = { cumplido: null, resultado: null }; }); } return this.data[this.currentWeek]; } toggleVistaTotal() { // Invierte el estado actual (si es true, se vuelve false, y viceversa) this.viendoTodo = !this.viendoTodo; // Vuelve a renderizar las estad√≠sticas con el nuevo estado this.renderMonthlyStats(); } renderAll() { this.renderWeekDisplay(); this.renderDias(); this.renderEstadisticas(); this.renderMonthlyStats(); this.renderHistorial(); this.loadCurrentWeekData(); } renderWeekDisplay() { document.getElementById('currentWeekDisplay').textContent = this.formatWeekName(this.currentWeek); } renderDias() { const container = document.getElementById('diasGrid'); container.innerHTML = `
D√≠a
Reto
Operativa
`; const weekData = this.getCurrentWeekData(); const isCompletada = weekData.completada; this.dias.forEach(dia => { const diaKey = dia.toLowerCase(); const diaData = weekData.dias[diaKey]; const diaElemento = document.createElement('div'); diaElemento.className = 'dia-linea'; diaElemento.style.gridTemplateColumns = "100px 40px 40px 1fr"; diaElemento.innerHTML = ` ${dia}‚úì
‚úó

Resultado...
`; container.appendChild(diaElemento); }); this.actualizarBotonGuardar(); } toggleDia(diaKey, cumplido) { const weekData = this.getCurrentWeekData(); const dia = weekData.dias[diaKey]; if (dia.cumplido === cumplido) { dia.cumplido = null; } else { dia.cumplido = cumplido; } this.saveData(); this.renderDias(); this.renderEstadisticas(); } renderEstadisticas() { const weekData = this.getCurrentWeekData(); const dias = Object.values(weekData.dias); const diasCumplidos = dias.filter(d => d.cumplido === true).length; const resultadosPositivos = dias.filter(d => d.resultado === 'positivo').length; const resultadosNegativos = dias.filter(d => d.resultado === 'negativo').length; const diasMarcados = dias.filter(d => d.cumplido !== null).length; const porcentajeCumplimiento = diasMarcados > 0 ? Math.round((diasCumplidos / diasMarcados) * 100) : 0; const efectividad = diasCumplidos > 0 ? Math.round(dias.filter(d => d.cumplido === true && d.resultado === 'positivo').length / diasCumplidos * 100) : 0; document.getElementById('diasCumplidos').textContent = diasCumplidos; document.getElementById('resultadosPositivos').textContent = resultadosPositivos; document.getElementById('resultadosNegativos').textContent = resultadosNegativos; document.getElementById('porcentajeCumplimiento').textContent = `${porcentajeCumplimiento}%`; document.getElementById('efectividad').textContent = `${efectividad}%`; this.renderChart(dias); } renderChart(dias) { const canvas = document.getElementById('chartCanvas'); if (!canvas) return; if (this.chartInstance) this.chartInstance.destroy(); const retoData = dias.map(d => d.cumplido === null ? null : (d.cumplido ? 1 : 0)); const operativaData = dias.map(d => d.resultado === null ? null : (d.resultado === 'positivo' ? 1 : -1)); this.chartInstance = new Chart(canvas.getContext('2d'), { type: 'line', data: { labels: this.dias, datasets: [{ label: 'Cumplimiento Reto', data: retoData, borderColor: '#00f2ea', tension: 0.4 }, { label: 'Resultado Operativa', data: operativaData, borderColor: '#ef44bc', tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#b3b3b3', callback: v => { if (v === 1) return 'Positivo/Cumplido'; if (v === 0) return 'Neutral/No Cumplido'; if (v === -1) return 'Negativo'; return null; } } }, x: { ticks: { color: '#b3b3b3' } } }, plugins: { legend: { labels: { color: '#ffffff' } }, title: { display: true, text: 'Progreso Semanal: Reto vs Operativa', color: '#ffffff' } } } }); } renderMonthlyStats() { const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']; const titulo = document.getElementById('currentMonth'); const prevBtn = document.getElementById('prevMonthBtn'); const nextBtn = document.getElementById('nextMonthBtn'); const toggleBtn = document.getElementById('toggleTotalViewBtn'); let semanasDelPeriodo; if (this.viendoTodo) { // --- MODO "VER TODO" --- titulo.textContent = 'Historial Completo'; toggleBtn.textContent = 'Ver por Mes'; // Cambia el texto para ofrecer la acci√≥n de volver prevBtn.style.display = 'none'; // Ocultamos los botones de navegaci√≥n nextBtn.style.display = 'none'; semanasDelPeriodo = Object.keys(this.data).filter(k => this.data[k].completada); } else { // --- MODO MENSUAL --- titulo.textContent = `${monthNames[this.currentMonth]} ${this.currentYear}`; toggleBtn.textContent = 'Ver Todo'; // El texto vuelve a su estado original prevBtn.style.display = 'inline-block'; // Mostramos los botones de nuevo nextBtn.style.display = 'inline-block'; semanasDelPeriodo = Object.keys(this.data).filter(k => this.data[k].completada && new Date(this.getWeekDates(k)).getMonth() === this.currentMonth && new Date(this.getWeekDates(k)).getFullYear() === this.currentYear ); } // --- El resto de la l√≥gica de c√°lculo y renderizado no cambia --- let totalDiasCumplidos = 0, totalPositivos = 0, totalDiasMarcados = 0; semanasDelPeriodo.forEach(key => { const dias = Object.values(this.data[key].dias); totalDiasCumplidos += dias.filter(d => d.cumplido === true).length; totalPositivos += dias.filter(d => d.resultado === 'positivo').length; totalDiasMarcados += dias.filter(d => d.cumplido !== null).length; }); document.getElementById('semanasDelMes').textContent = semanasDelPeriodo.length; document.getElementById('diasCumplidosMes').textContent = totalDiasCumplidos; document.getElementById('positivosMes').textContent = totalPositivos; document.getElementById('cumplimientoMes').textContent = `${totalDiasMarcados > 0 ? Math.round((totalDiasCumplidos / totalDiasMarcados) * 100) : 0}%`; this.renderMonthlyChart(semanasDelPeriodo); } renderMonthlyChart(semanasDelMes) { const canvas = document.getElementById('monthlyChart'); if (!canvas) return; if (this.monthlyChartInstance) this.monthlyChartInstance.destroy(); const ctx = canvas.getContext('2d'); if (semanasDelMes.length === 0) { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = '#6c757d'; ctx.textAlign = 'center'; ctx.fillText('No hay datos para este mes', canvas.width / 2, canvas.height / 2); return; } const labels = semanasDelMes.map(k => `Semana ${k.split('-W')[1]}`); const cumplidosData = semanasDelMes.map(k => Object.values(this.data[k].dias).filter(d => d.cumplido === true).length); const positivosData = semanasDelMes.map(k => Object.values(this.data[k].dias).filter(d => d.resultado === 'positivo').length); this.monthlyChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'D√≠as Cumplidos', data: cumplidosData, backgroundColor: '#00f2ea' }, { label: 'Resultados Positivos', data: positivosData, backgroundColor: '#ef44bc' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#b3b3b3', stepSize: 1 } } }, plugins: { legend: { labels: { color: '#ffffff' } }, title: { display: true, text: 'Resumen Mensual por Semana', color: '#ffffff' } } } }); } renderHistorial() { const container = document.getElementById('historialContainer'); container.innerHTML = ''; const semanas = Object.keys(this.data).filter(key => this.data[key].completada).sort((a, b) => b.localeCompare(a)); if (semanas.length === 0) { container.innerHTML = '
No hay historial disponible

'; return; } semanas.forEach(key => { const semanaData = this.data[key]; const dias = Object.values(semanaData.dias); const cumplidos = dias.filter(d => d.cumplido === true).length; const positivos = dias.filter(d => d.resultado === 'positivo').length; const porcentaje = dias.filter(d => d.cumplido !== null).length > 0 ? Math.round(cumplidos / dias.filter(d => d.cumplido !== null).length * 100) : 0; const item = document.createElement('div'); item.className = 'historial-item'; item.innerHTML = `
${this.formatWeekName(key)}
${cumplidos}/5 cumplidos (${porcentaje}%), ${positivos} positivos
${semanaData.reto || 'Sin reto'}
VerEliminar
`; container.appendChild(item); }); } changeWeek(direction) { const [year, week] = this.currentWeek.split('-W'); let newWeek = parseInt(week) + direction; let newYear = parseInt(year); if (newWeek < 1) { newWeek = 52; newYear--; } else if (newWeek > 52) { newWeek = 1; newYear++; } this.currentWeek = `${newYear}-W${String(newWeek).padStart(2, '0')}`; this.renderAll(); } changeMonth(direction) { this.currentMonth += direction; if (this.currentMonth < 0) { this.currentMonth = 11; this.currentYear--; } else if (this.currentMonth > 11) { this.currentMonth = 0; this.currentYear++; } this.renderMonthlyStats(); } updateResultado(diaKey, resultado) { this.getCurrentWeekData().dias[diaKey].resultado = resultado || null; this.saveData(); this.renderEstadisticas(); } updateReto(reto) { if (!this.getCurrentWeekData().retoFijo) this.getCurrentWeekData().reto = reto; this.saveData(); } fixReto() { const weekData = this.getCurrentWeekData(); if (weekData.reto && !weekData.retoFijo) { weekData.retoFijo = true; this.saveData(); this.loadCurrentWeekData(); } } editarReto() { document.getElementById('retoInput').disabled = false; document.getElementById('retoInput').focus(); document.getElementById('btnEditarReto').style.display = 'none'; document.getElementById('btnGuardarReto').style.display = 'flex'; } guardarReto() { const weekData = this.getCurrentWeekData(); weekData.reto = document.getElementById('retoInput').value; weekData.retoFijo = true; this.saveData(); this.loadCurrentWeekData(); } loadCurrentWeekData() { const weekData = this.getCurrentWeekData(); const retoInput = document.getElementById('retoInput'); const btnEditar = document.getElementById('btnEditarReto'); const btnGuardar = document.getElementById('btnGuardarReto'); retoInput.value = weekData.reto; retoInput.disabled = weekData.retoFijo || weekData.completada; if (weekData.completada) { btnEditar.style.display = 'none'; btnGuardar.style.display = 'none'; } else if (weekData.retoFijo) { btnEditar.style.display = 'flex'; btnGuardar.style.display = 'none'; } else { btnEditar.style.display = 'none'; btnGuardar.style.display = 'none'; } } actualizarBotonGuardar() { const weekData = this.getCurrentWeekData(); const diasMarcados = Object.values(weekData.dias).filter(d => d.cumplido !== null || d.resultado !== null).length; document.getElementById('btnGuardarHistorial').style.display = (weekData.reto && diasMarcados > 0 && !weekData.completada) ? 'block' : 'none'; } guardarEnHistorial() { this.getCurrentWeekData().completada = true; this.saveData(); alert('Semana finalizada y guardada en el historial.'); this.renderAll(); } verSemana(semanaKey) { this.currentWeek = semanaKey; this.renderAll(); document.getElementById('Retos').scrollIntoView({ behavior: 'smooth' }); } eliminarSemana(semanaKey) { if (confirm(`¬øEst√°s seguro de que quieres eliminar la semana ${this.formatWeekName(semanaKey)}?`)) { delete this.data[semanaKey]; this.saveData(); this.renderAll(); } } borrarHistorial() { if (confirm('¬øEst√°s seguro de que quieres borrar todo el historial?')) { Object.keys(this.data).forEach(key => { if (this.data[key].completada) delete this.data[key]; }); this.saveData(); this.renderAll(); } } getCurrentWeekKey() { const now = new Date(); const year = now.getFullYear(); const week = this.getWeekNumber(now); return `${year}-W${String(week).padStart(2, '0')}`; } getWeekDates(weekKey) { const [year, week] = weekKey.split('-W'); const d = new Date(year, 0, 1 + (parseInt(week) - 1) * 7); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)); } getWeekNumber(date) { const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); } formatWeekName(weekKey) { const weekStart = this.getWeekDates(weekKey); const weekEnd = new Date(weekStart); weekEnd.setDate(weekEnd.getDate() + 4); const formatDate = (date) => date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }); return `${formatDate(weekStart)} - ${formatDate(weekEnd)}`; } } // --- INICIALIZACI√ìN CONTROLADA --- let app; const originalOpenTab = window.openTab; window.openTab = function(tabName) { originalOpenTab(tabName); if (tabName === 'Retos' && !window.app) { window.app = new RetosSemanales(); }